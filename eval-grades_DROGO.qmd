---
title: "eval-grades_DROGO"
author: "Louis DROGO"
format: html
editor: visual
---


```{r}
#| message: false
#| echo: false

library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)
library(vroom)
library(here)

here::i_am("eval-grades.Rproj")
```


# I - Introduction

Here is the link to my github [graded lab](https://github.com/louisdrogo97/eval-grades.git).

## 1. Study Organisation

### Question 1

```{r}
courses <- vroom("Data/courses.csv",delim = ",", show_col_types = FALSE)
```

### Question 2

```{r}
#| echo: false
courses |>
  arrange(course)|>
  rename("course name"=course,
         "identifier"=course_id,
         "number of exam"=nb_grades)|>
  knitr::kable()
```


## 2. Students

### Question 3

```{r}
#| echo: false
students <- vroom("Data/students.csv",delim = ",",show_col_types = FALSE)
students$sex <- as.factor(students$sex)
sapply(students, class)
```
## 3. Graddes

### Question 4

```{r}
#| warning: false
grades <- vroom("Data/grades.csv",delim = "|",na=c("$"),show_col_types = FALSE)
grades$grade <- as.numeric(grades$grade)
```


# II - Population

### Question 5

```{r}
students |>
  group_by(group)|>
  summarise(count=n())|>
  ggplot(aes(x=group,y=count))+
  geom_col()+
  labs(title = "Number of Students per Group",x = "Group Number",y = "Number of Students")
```


### Question 6

```{r}
students |>
  group_by(group,sex)|>
  summarise(count=n(),.groups = "drop")|>
  ggplot(aes(x=group,y=count,fill = sex))+
  geom_col()+
  labs(title = "Gender balance per Group",x = "Group Number",y = "Number of Students")
```


### Question 7

```{r}
students <- students |>
  mutate(age=time_length(today()- birth_date, unit="year"))

students$age <- round(students$age) # I round every age to the closest integer

students |>
  ggplot(aes(x=age))+
  geom_histogram(binwidth = 1, color = "white")+
  labs(title = "Distribution of Student Age",x = "Age (Years)",y = "Density / Count")+
  theme_minimal()
```


### Question 8

```{r}
students |>
  group_by(group)|>
  summarise(median=round(median(age)))|>
  knitr::kable()
```

### Question 9

```{r}
students|>
  group_by(group)|>
  slice_max(order_by = age, n = 1, with_ties = FALSE)|>
  select(id, sex, age, group)|>
  arrange(desc(age))|>
  knitr::kable()
```


# III - Simple grade analysis

### Question 10

```{r}
nb_grades <- grades |>
  filter(!is.na(grade))|>
  nrow()
nb_grades
```

The data set contains **`r nb_grades`** grades.

### Question 11

```{r}
course_id11 <- courses |>
  filter(course == "Engineering and Technology of the Roman Empire") |>
  pull(course_id)

avg_grades <- grades |>
  filter(course_id == course_id11, !is.na(grade)) |>
  left_join(students |> select(id, group), by = "id") |>
  group_by(group) |>
  summarise(average_grades = mean(grade, na.rm = TRUE), .groups = "drop")

ggplot(avg_grades, aes(x = group, y = average_grades)) +
  geom_col()

```

### Question 12

```{r}
grades |>
  left_join(courses %>% select(course_id, trimester), by = "course_id") |>
  filter(!is.na(grade), !is.na(trimester)) |>
  mutate(trimester = as.factor(trimester)) |>
  ggplot(aes(x = grade)) + 
    geom_histogram(binwidth = 1, color = "white") +
    facet_wrap(~ trimester, scales = "free_y", ncol = 3)+
  labs(title = "Distribution of grades per trimester",x = "Grades",y = "Number of obs")
```


# V - Attendance analysis

### Question 13

```{r}
grades |>
  filter(!is.na(grade)) |>
  left_join(students |> select(id,group,sex), by = "id")|>
  group_by(id,group,sex) |>
  summarise(nb_grades = n(), .groups = 'drop')|>
  slice_tail(n=5)|>
  knitr::kable()
```


### Question 14

```{r}
grades |>
  filter(!is.na(grade)) |>
  left_join(students |> select(id,group,sex), by = "id")|>
  group_by(id,group,sex) |>
  summarise(nb_grades = n(), .groups = 'drop')|>
  ggplot(aes(x = nb_grades, fill = sex)) +
  geom_density(alpha = 0.4)
```


### Question 15

```{r}
course_id15 <- courses|>
  filter(course == "Latin Language and Literature") |>
  pull(course_id)

grades_id15 <- grades |>
  filter(course_id == course_id15, !is.na(grade)) |>
  group_by(id) |>
  summarise(nb_grades= n(), .groups = 'drop')

students |>
  select(id, group) |>
  left_join(grades_id15, by = "id") |>
  select(id, group, nb_grades)|>
  slice_tail(n=5)|>
  knitr::kable()
```

### Question 16

```{r}
grades_id15 |>
  group_by(nb_grades)|>
  summarise(count=n())|>
  ggplot(aes(x=as.factor(nb_grades),y=count))+
  geom_col()
```

### Question 17

```{r}
#| warning: false
grades_lat_lit_complete <- students |>
  select(id, group) |>
  left_join(grades_id15, by = "id")
grades_lat_lit_complete|>
  ggplot(aes(x = group, y = nb_grades)) +
  geom_boxplot()
```


### Question 18

```{r}
grades_lat_lit_sex <- grades_lat_lit_complete |>
  left_join(students |> select(id, sex), by = "id")

grades_lat_lit_sex |>
  ggplot(aes(x = group, y = nb_grades, fill = sex)) +
  geom_boxplot(position = position_dodge(width = 0.8))
```
# V - Grade analysis

### Question 19

```{r}
average_grades_long <- grades |>
  filter(!is.na(grade)) |>
  group_by(id, course_id) |>
  summarise(avg_grade = mean(grade), .groups = 'drop')

average_grades_by_course <- average_grades_long |>
  left_join(courses |> select(course_id, course), by = "course_id") |>
  left_join(students |> select(id, group), by = "id") |>
  select(id, group, course, avg_grade)

average_grades_wide <- average_grades_by_course |>
  pivot_wider(
    id_cols = c(id, group),
    names_from = course,
    values_from = avg_grade
  ) |>
  arrange(id)

course_cols_q19 <- courses |> pull(course) |> head(2)
knitr::kable(average_grades_wide |> select(id, group, all_of(course_cols_q19)) |> slice_head(n = 5))
```


### Question 20

```{r}
#| warning: false
#| echo: false
course_lat <- "Latin Language and Literature"
course_xeno <- "Xenology and Extraterrestrial Life"

average_grades_wide |>
  ggplot(aes(x = .data[[course_xeno]], y = .data[[course_lat]])) +
  geom_point(alpha = 0.6, color = "darkgreen") +
  geom_smooth(method = "lm", se = FALSE, color = "red")
```


### Question 21

```{r}
course_med <- "Medicine and Healthcare"
course_war <- "Galactic Warfare and Military Tactics"

correlation_by_group <- average_grades_wide |>
  group_by(group) |>
  summarise(correlation = cor(.data[[course_med]], .data[[course_war]], use ="pairwise.complete.obs"),.groups = 'drop') |>
  mutate(correlation = round(correlation, 4))

knitr::kable(correlation_by_group)
```


### Question 22

```{r}
#| warning: false
#| echo: false
course_med <- "Medicine and Healthcare"
course_war <- "Galactic Warfare and Military Tactics"

correlation_by_group <- average_grades_wide |>
  group_by(group) |>
  summarise(
    correlation = cor(.data[[course_med]], .data[[course_war]], use = "pairwise.complete.obs"),
    .groups = 'drop'
  )

most_correlated_group <- correlation_by_group |>
  mutate(abs_correlation = abs(correlation)) |>
  slice_max(abs_correlation, n = 1) |>
  pull(group) |>
  as.character()

data_most_correlated_group <- average_grades_wide |>
  filter(group == most_correlated_group)

ggplot(data_most_correlated_group, aes(x = .data[[course_war]], y = .data[[course_med]])) +
  geom_point(color = "darkred", alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE, color = "blue")
```

